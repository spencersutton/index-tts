"""
This module provides Source classes that track the origins of values in PyTorch Dynamo.
Sources represent where values come from (e.g. local variables, globals, attributes) and
are used for guard generation and code reconstruction during compilation.

The module includes specialized sources for:
- Local variables and synthetic locals
- Global variables and constants
- Object attributes and method calls
- NN module specialization (specialized vs unspecialized)
- Random values and tensor properties
- Default argument handling
- FSDP (Fully Sharded Data Parallel) modules

Sources play a key role in Dynamo's guard system by tracking value origins for
guard generation, and in code reconstruction by providing methods to rebuild
the code needed to recreate values.
"""

import dataclasses
import enum
import functools
from collections.abc import Callable
from typing import Any

from torch._guards import ChainedSource, Guard, GuardSource, Source

from .codegen import PyCodegen

_GUARD_SOURCE_SPECIALIZED_NN_MODULE = ...
_GUARD_SOURCE_UNSPECIALIZED_NN_MODULE = ...
_GUARD_SOURCE_UNSPECIALIZED_BUILTIN_NN_MODULE = ...
_GUARD_SOURCE_FSDP_MODULE = ...

def is_constant_source(source: Source) -> bool: ...

@dataclasses.dataclass(frozen=True)
class LocalSource(Source):
    """LocalSource(local_name: str, is_input: bool = False, dynamism: Optional[frozenset[str]] = None, is_derefed_cell_contents: bool = False)"""

    local_name: str
    is_input: bool = ...
    dynamism: frozenset[str] | None = ...
    is_derefed_cell_contents: bool = ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class SyntheticLocalSource(Source):
    """SyntheticLocalSource(local_name: str)"""

    local_name: str
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class RandomValueSource(Source):
    """RandomValueSource(random_call_index: int)"""

    random_call_index: int
    def guard_source(self) -> GuardSource: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class GlobalSource(Source):
    """GlobalSource(global_name: str)"""

    global_name: str
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class GlobalWeakRefSource(Source):
    """GlobalWeakRefSource(global_name: str)"""

    global_name: str
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class WeakRefCallSource(ChainedSource):
    """WeakRefCallSource(base: 'Source')"""
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class CallFunctionNoArgsSource(WeakRefCallSource):
    """CallFunctionNoArgsSource(base: 'Source')"""

@dataclasses.dataclass(frozen=True)
class AttrSource(ChainedSource):
    """AttrSource(base: 'Source', member: str)"""

    member: str
    def __post_init__(self) -> None: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class GenericAttrSource(ChainedSource):
    """GenericAttrSource(base: 'Source', member: str)"""

    member: str
    def __post_init__(self) -> None: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class TypeDictSource(ChainedSource):
    """TypeDictSource(base: 'Source')"""
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class TypeMROSource(ChainedSource):
    """TypeMROSource(base: 'Source')"""
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class LocalCellSource(Source):
    """
    Conceptually, this class is `LocalSource` for cell objects implicitly
    generated by Python (e.g., captured variables).
    """

    local_name: str
    def reconstruct(self, codegen: PyCodegen) -> None: ...

@dataclasses.dataclass(frozen=True)
class CodeSource(ChainedSource):
    """CodeSource(base: 'Source')"""
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class ClosureSource(ChainedSource):
    """ClosureSource(base: 'Source')"""
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class GradSource(ChainedSource):
    """GradSource(base: 'Source', member: str = 'grad')"""

    member: str = ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class ParamBufferSource(AttrSource):
    """ParamBufferSource(base: 'Source', member: str)"""
    def guard_source(self) -> GuardSource: ...

@dataclasses.dataclass(frozen=True)
class UnspecializedParamBufferSource(AttrSource):
    """UnspecializedParamBufferSource(base: 'Source', member: str)"""

@dataclasses.dataclass(frozen=True)
class EphemeralSource(Source):
    """EphemeralSource(desc: Optional[str] = None)"""

    desc: str | None = ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...
    def make_guard(self, fn: Callable[..., Any]) -> Guard: ...
    def is_ephemeral(self) -> bool: ...

@dataclasses.dataclass(frozen=True)
class SkipGuardSource(ChainedSource):
    """SkipGuardSource(base: 'Source')"""
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

class TensorProperty(enum.Enum):
    SIZE = ...
    STRIDE = ...
    STORAGE_OFFSET = ...
    def method_name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class TensorPropertySource(ChainedSource):
    """TensorPropertySource(base: 'Source', prop: torch._dynamo.source.TensorProperty, idx: Optional[int] = None)"""

    prop: TensorProperty
    idx: int | None = ...
    def __post_init__(self) -> None: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class IndexedSource(ChainedSource):
    """IndexedSource(base: 'Source', idx: int)"""

    idx: int
    def __post_init__(self) -> None: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class NegateSource(ChainedSource):
    """NegateSource(base: 'Source')"""
    def __post_init__(self) -> None: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class ConvertIntSource(ChainedSource):
    """ConvertIntSource(base: 'Source')"""
    def __post_init__(self) -> None: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class FlattenScriptObjectSource(ChainedSource):
    """FlattenScriptObjectSource(base: 'Source')"""
    def __post_init__(self) -> None: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class ScriptObjectQualifiedNameSource(ChainedSource):
    """ScriptObjectQualifiedNameSource(base: 'Source')"""
    def __post_init__(self) -> None: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

class AttrProxySource(ChainedSource):
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class DefaultsSource(ChainedSource):
    """DefaultsSource(base: 'Source', idx_key: Union[int, str], is_kw: bool = False)"""

    idx_key: int | str
    is_kw: bool = ...
    field: str = ...
    _name: str = ...
    def __post_init__(self) -> None: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class GetItemSource(ChainedSource):
    """GetItemSource(base: 'Source', index: Any, index_is_slice: bool = False)"""

    index: Any
    index_is_slice: bool = ...
    def __post_init__(self) -> None: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def unpack_slice(self) -> slice: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class ConstDictKeySource(ChainedSource):
    """ConstDictKeySource(base: 'Source', index: Any)"""

    index: Any
    def guard_source(self) -> GuardSource: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def name(self) -> str: ...
    def is_dict_key(self) -> bool: ...

@dataclasses.dataclass(frozen=True)
class NonSerializableSetGetItemSource(ChainedSource):
    """NonSerializableSetGetItemSource(base: 'Source', index: int)"""

    index: int
    def __post_init__(self) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def name(self) -> str: ...
    def is_dict_key(self) -> bool: ...

@dataclasses.dataclass(frozen=True)
class DictGetItemSource(ChainedSource):
    """DictGetItemSource(base: 'Source', index: Any)"""

    index: Any
    def __post_init__(self) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class DictSubclassGetItemSource(ChainedSource):
    """DictSubclassGetItemSource(base: 'Source', index: Any)"""

    index: Any
    def __post_init__(self) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class ListGetItemSource(GetItemSource):
    """Same as GetItemSource with reconstruct and name overridden to be list specific."""
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class TupleIteratorGetItemSource(GetItemSource):
    """TupleIteratorGetItemSource(base: 'Source', index: Any, index_is_slice: bool = False)"""
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class NamedTupleFieldsSource(ChainedSource):
    """NamedTupleFieldsSource(base: 'Source')"""
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class DataclassFieldsSource(ChainedSource):
    """DataclassFieldsSource(base: 'Source')"""
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class TypeSource(ChainedSource):
    """TypeSource(base: 'Source')"""
    def __post_init__(self) -> None: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class OptimizerSource(ChainedSource):
    """OptimizerSource(base: 'Source')"""
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class NNModuleSource(ChainedSource):
    """NNModuleSource(base: 'Source')"""
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...

@dataclasses.dataclass(frozen=True)
class UnspecializedNNModuleSource(NNModuleSource):
    """UnspecializedNNModuleSource(base: 'Source')"""
    def guard_source(self) -> GuardSource: ...

@dataclasses.dataclass(frozen=True)
class UnspecializedBuiltinNNModuleSource(UnspecializedNNModuleSource):
    """UnspecializedBuiltinNNModuleSource(base: 'Source')"""
    def guard_source(self) -> GuardSource: ...

@dataclasses.dataclass(frozen=True)
class FSDPNNModuleSource(NNModuleSource):
    """FSDPNNModuleSource(base: 'Source')"""
    def guard_source(self) -> GuardSource: ...

@dataclasses.dataclass(frozen=True)
class GlobalStateSource(Source):
    """GlobalStateSource()"""
    def name(self) -> str: ...
    def guard_source(self) -> GuardSource: ...

@dataclasses.dataclass(frozen=True)
class TorchSource(Source):
    """
    Points to the actual `torch` module - used instead of GlobalSource
    in case the user has overridden `torch` in their local namespace
    """
    def __init__(self, *args: Any, **kwargs: Any) -> None: ...
    def name(self) -> str: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...

@dataclasses.dataclass(frozen=True)
class TorchFunctionModeStackSource(Source):
    """TorchFunctionModeStackSource(ind: int)"""

    ind: int
    def name(self) -> str: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...

@dataclasses.dataclass(frozen=True)
class ConstantSource(Source):
    """ConstantSource(source_name: str)"""

    source_name: str
    def reconstruct(self, codegen: PyCodegen) -> None: ...
    def guard_source(self) -> GuardSource: ...
    def name(self) -> str: ...
    def make_guard(self, fn: Any) -> Any: ...

@dataclasses.dataclass(frozen=True)
class NumpyTensorSource(ChainedSource):
    """NumpyTensorSource(base: 'Source')"""
    def name(self) -> str: ...
    def guard_source(self) -> GuardSource: ...
    def reconstruct(self, codegen: PyCodegen) -> None: ...

@dataclasses.dataclass(frozen=True)
class SubclassAttrListSource(ChainedSource):
    """SubclassAttrListSource(base: 'Source')"""
    def name(self) -> str: ...
    def guard_source(self) -> GuardSource: ...

@dataclasses.dataclass(frozen=True)
class FloatTensorSource(ChainedSource):
    """FloatTensorSource(base: 'Source')"""
    def name(self) -> str: ...
    def guard_source(self) -> GuardSource: ...

@dataclasses.dataclass(frozen=True)
class CallMethodItemSource(ChainedSource):
    """CallMethodItemSource(base: 'Source')"""
    def name(self) -> str: ...
    def guard_source(self) -> GuardSource: ...

@dataclasses.dataclass(frozen=True)
class ShapeEnvSource(Source):
    """ShapeEnvSource()"""
    def name(self) -> str: ...
    def guard_source(self) -> GuardSource: ...

@dataclasses.dataclass(frozen=True)
class BackwardStateSource(Source):
    """BackwardStateSource()"""
    def name(self) -> str: ...
    def guard_source(self) -> GuardSource: ...

def get_local_source_name(source: Source, *, only_allow_input: bool = ...) -> str | None: ...
def is_from_local_source(source: Source, *, only_allow_input: bool = ...) -> bool: ...
def is_from_global_source(source: Source) -> bool: ...
def get_global_source_name(source: Source) -> str | None: ...
def is_from_nonlocal_source(source: Source) -> bool: ...
def is_from_closure_source(source: Source) -> bool: ...
def is_from_source(source: Source, target: Source) -> bool: ...
@functools.lru_cache
def is_from_unspecialized_nn_module_source(source: Source) -> bool: ...
@functools.lru_cache
def is_from_unspecialized_builtin_nn_module_source(source: Source) -> bool: ...
@functools.lru_cache
def is_from_unspecialized_param_buffer_source(source: Source) -> bool: ...
@functools.lru_cache
def is_from_flatten_script_object_source(source: Source) -> bool: ...
@functools.lru_cache
def is_from_optimizer_source(source: Source) -> bool: ...
@functools.lru_cache
def is_from_defaults(source: Source) -> bool: ...
@functools.lru_cache
def is_from_skip_guard_source(source: Source) -> bool: ...
