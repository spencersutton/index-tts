import dataclasses
from typing import Any, override

from torch.compiler._cache import CacheArtifact, CacheArtifactFactory

from ..remote_cache import JsonDataTy, RemoteCache, RemoteCacheBackend
from .triton_compat import Config

log = ...
type _InductorMetaTy = dict[str, object]

def inductor_meta_from_config() -> _InductorMetaTy: ...

@CacheArtifactFactory.register
class AutotuneCacheArtifact(CacheArtifact):
    @override
    def populate_cache(self) -> None: ...
    @override
    @staticmethod
    def type() -> str: ...
    @override
    @staticmethod
    def encode(content: JsonDataTy) -> bytes: ...

@dataclasses.dataclass
class AutotuneCache:
    configs_hash: str
    local_cache: tuple[RemoteCache[JsonDataTy], str] | None = ...
    remote_cache: tuple[RemoteCache[JsonDataTy], str] | None = ...
    @staticmethod
    def create(inductor_meta: _InductorMetaTy, filename: str, configs_hash: str) -> AutotuneCache | None: ...
    def read_best(self, inductor_meta: _InductorMetaTy, configs: list[Config]) -> Config | None: ...
    def __getstate__(self) -> dict[str, Any]: ...
    def __setstate__(self, state: dict[str, Any]) -> None: ...
    def save(
        self, config: Config, time_taken_ns: int, found_by_coordesc: bool = ..., triton_cache_hash: str | None = ...
    ) -> None: ...

class _AutotuneCacheBundlerImpl:
    _key: str
    _cache: RemoteCache[JsonDataTy]
    _entries: dict[str, JsonDataTy]
    def end_compile(self) -> None: ...
    def put(self, basename: str, data: JsonDataTy) -> None: ...
    def __init__(self, key: str, cache: RemoteCache[JsonDataTy]) -> None: ...
    def sync(self) -> None: ...

class AutotuneCacheBundler:
    _bundler: _AutotuneCacheBundlerImpl | None = ...
    def __init__(self) -> None: ...
    @classmethod
    def begin_compile(
        cls, inductor_meta: _InductorMetaTy, *, code: str | None = ..., code_hash: str | None = ...
    ) -> None: ...
    @classmethod
    def end_compile(cls) -> None: ...
    @classmethod
    def sync(cls) -> None: ...
    @classmethod
    def put(cls, filename: str, data: JsonDataTy) -> None: ...

class _LocalAutotuneCacheBackend(RemoteCacheBackend[bytes]): ...

class LocalAutotuneCache(RemoteCache[JsonDataTy]):
    def __init__(self) -> None: ...
