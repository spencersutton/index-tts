import types
from collections.abc import Callable, Iterable
from typing import TYPE_CHECKING, Any
from weakref import WeakValueDictionary

import torch
from torch.types import FileLike

from .file_structure_representation import Directory
from .glob_group import GlobPattern
from .importer import Importer

if TYPE_CHECKING: ...
__all__ = ["PackageImporter"]
IMPLICIT_IMPORT_ALLOWLIST: Iterable[str] = ...
EXTERN_IMPORT_COMPAT_NAME_MAPPING: dict[str, dict[str, Any]] = ...

class PackageImporter(Importer):
    modules: dict[str, types.ModuleType]
    def __init__(
        self,
        file_or_buffer: FileLike | torch._C.PyTorchFileReader,
        module_allowed: Callable[[str], bool] = ...,
    ) -> None: ...
    def import_module(self, name: str, package=...) -> ModuleType | object: ...
    def load_binary(self, package: str, resource: str) -> bytes: ...
    def load_text(
        self,
        package: str,
        resource: str,
        encoding: str = ...,
        errors: str = ...,
    ) -> str: ...
    def load_pickle(self, package: str, resource: str, map_location=...) -> Any: ...
    def id(self) -> str: ...
    def file_structure(self, *, include: GlobPattern = ..., exclude: GlobPattern = ...) -> Directory: ...
    def python_version(self) -> Any | None: ...
    def get_source(self, module_name) -> str: ...
    def get_resource_reader(self, fullname) -> _PackageResourceReader | None: ...
    def __import__(self, name, globals=..., locals=..., fromlist=..., level=...) -> ModuleType | object: ...

_NEEDS_LOADING = ...
_ERR_MSG_PREFIX = ...
_ERR_MSG = ...

class _PathNode: ...

class _PackageNode(_PathNode):
    def __init__(self, source_file: str | None) -> None: ...

class _ModuleNode(_PathNode):
    __slots__ = ...
    def __init__(self, source_file: str) -> None: ...

class _ExternNode(_PathNode): ...

_package_imported_modules: WeakValueDictionary = ...
_orig_getfile = ...

class _PackageResourceReader:
    def __init__(self, importer, fullname) -> None: ...
    def open_resource(self, resource) -> BytesIO: ...
    def resource_path(self, resource): ...
    def is_resource(self, name): ...
    def contents(self) -> Generator[str, Any, None]: ...
